{/* Inlined to avoid FOUC. This is a parser blocking script. */}
<script is:inline>
	// 1. CHANGE: Check for "Dark" preference specifically.
	// This ensures that if the system is "Light" OR "No Preference", we default to Light.
	const darkModePref = window.matchMedia("(prefers-color-scheme: dark)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		// If no stored theme, return "dark" ONLY if the system explicitly asks for it. Otherwise "light".
		return storedTheme || (darkModePref.matches ? "dark" : "light");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// 2. CHANGE: Toggle the class 'dark'.
		// This is REQUIRED for Tailwind's "dark:" utilities to work.
		if (newTheme === "dark") {
			root.classList.add("dark");
		} else {
			root.classList.remove("dark");
		}

		// Keep the data-attribute for your CSS variables
		root.setAttribute("data-theme", newTheme);

		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	darkModePref.addEventListener("change", (e) => setTheme(e.matches ? "dark" : "light"));
</script>
